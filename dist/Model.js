"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");var _slicedToArray2=_interopRequireDefault(require("@babel/runtime/helpers/slicedToArray"));var _classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));var _createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass"));var __createBinding=this&&this.__createBinding||(Object.create?function(o,m,k,k2){if(k2===undefined)k2=k;var desc=Object.getOwnPropertyDescriptor(m,k);if(!desc||("get"in desc?!m.__esModule:desc.writable||desc.configurable)){desc={enumerable:true,get:function get(){return m[k];}};}Object.defineProperty(o,k2,desc);}:function(o,m,k,k2){if(k2===undefined)k2=k;o[k2]=m[k];});var __setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(o,v){Object.defineProperty(o,"default",{enumerable:true,value:v});}:function(o,v){o["default"]=v;});var __importStar=this&&this.__importStar||function(mod){if(mod&&mod.__esModule)return mod;var result={};if(mod!=null)for(var k in mod)if(k!=="default"&&Object.prototype.hasOwnProperty.call(mod,k))__createBinding(result,mod,k);__setModuleDefault(result,mod);return result;};var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){function adopt(value){return value instanceof P?value:new P(function(resolve){resolve(value);});}return new(P||(P=Promise))(function(resolve,reject){function fulfilled(value){try{step(generator.next(value));}catch(e){reject(e);}}function rejected(value){try{step(generator["throw"](value));}catch(e){reject(e);}}function step(result){result.done?resolve(result.value):adopt(result.value).then(fulfilled,rejected);}step((generator=generator.apply(thisArg,_arguments||[])).next());});};Object.defineProperty(exports,"__esModule",{value:true});exports.Model=void 0;var SQLite=__importStar(require("expo-sqlite"));var Model=function(){function Model(){var attributes=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};(0,_classCallCheck2.default)(this,Model);Object.assign(this,attributes);this.clauses={select:'*',joins:[],where:[],orderBy:null,limit:null,withRelations:[]};}(0,_createClass2.default)(Model,[{key:"table",value:function table(name){this.tableName=name;return this;}},{key:"select",value:function select(){var fields=arguments.length>0&&arguments[0]!==undefined?arguments[0]:'*';this.clauses.select=Array.isArray(fields)?fields.join(', '):fields;return this;}},{key:"join",value:function join(type,table,firstKey,secondKey){this.clauses.joins.push({type:type,table:table,firstKey:firstKey,secondKey:secondKey});return this;}},{key:"where",value:function where(column,operatorOrValue,value){if(value===undefined){this.clauses.where.push({column:column,operator:'=',value:operatorOrValue});}else{this.clauses.where.push({column:column,operator:operatorOrValue,value:value});}return this;}},{key:"orderBy",value:function orderBy(column){var direction=arguments.length>1&&arguments[1]!==undefined?arguments[1]:'ASC';this.clauses.orderBy={column:column,direction:direction};return this;}},{key:"limit",value:function limit(number){this.clauses.limit=number;return this;}},{key:"with",value:function _with(relation){this.clauses.withRelations.push(relation);return this;}},{key:"save",value:function save(){return __awaiter(this,void 0,void 0,function*(){var _this=this;var constructor=this.constructor;var now=new Date().toISOString();var fields=Object.keys(this).filter(function(key){return key!=='id';});var sql;var values=fields.map(function(field){return constructor.prepareAttributeForStorage(field,_this[field]);});if(this.id){if(constructor.withTimestamps&&constructor.updatedAtColumn){this[constructor.updatedAtColumn]=now;fields.push(constructor.updatedAtColumn);values.push(now);}var setClause=fields.map(function(field){return`${field} = ?`;}).join(', ');sql=`UPDATE ${constructor.tableName} SET ${setClause} WHERE id = ?`;values.push(this.id);}else{if(constructor.withTimestamps){if(constructor.createdAtColumn){this[constructor.createdAtColumn]=now;fields.push(constructor.createdAtColumn);values.push(now);}if(constructor.updatedAtColumn){this[constructor.updatedAtColumn]=now;fields.push(constructor.updatedAtColumn);values.push(now);}}var placeholders=fields.map(function(){return'?';}).join(', ');sql=`INSERT INTO ${constructor.tableName} (${fields.join(', ')}) VALUES (${placeholders})`;}var result=yield constructor.executeSql(sql,values);if(!this.id&&result.insertId){this.id=result.insertId;}return result;});}},{key:"delete",value:function _delete(){var _a,_b;return __awaiter(this,void 0,void 0,function*(){var constructor=this.constructor;var sql;var params=[];if(((_b=(_a=this.clauses)===null||_a===void 0?void 0:_a.where)===null||_b===void 0?void 0:_b.length)>0){var whereConditions=this.clauses.where.map(function(clause){params.push(clause.value);return`${clause.column} ${clause.operator} ?`;});sql=`DELETE FROM ${constructor.tableName} WHERE ${whereConditions.join(' AND ')}`;}else if(this.id){sql=`DELETE FROM ${constructor.tableName} WHERE id = ?`;params.push(this.id);}else{throw new Error('Delete operation must specify a WHERE condition or an instance with id.');}return yield constructor.executeSql(sql,params);});}},{key:"getSql",value:function getSql(){var constructor=this.constructor;var query=`SELECT ${this.clauses.select} FROM ${constructor.tableName}`;var params=[];if(this.clauses.joins.length>0){var joinClauses=this.clauses.joins.map(function(joinClause){return`${joinClause.type} JOIN ${joinClause.table} ON ${joinClause.firstKey} = ${joinClause.secondKey}`;}).join(' ');query+=` ${joinClauses}`;}if(this.clauses.where.length>0){var whereClauses=this.clauses.where.map(function(clause){params.push(clause.value);return`${clause.column} ${clause.operator} ?`;}).join(' AND ');query+=` WHERE ${whereClauses}`;}if(this.clauses.orderBy){query+=` ORDER BY ${this.clauses.orderBy.column} ${this.clauses.orderBy.direction}`;}if(this.clauses.limit!==null){query+=` LIMIT ${this.clauses.limit}`;}return{query:query,params:params};}},{key:"get",value:function get(){return __awaiter(this,void 0,void 0,function*(){var _this2=this;var constructor=this.constructor;var _this$getSql=this.getSql(),query=_this$getSql.query,params=_this$getSql.params;var result=yield constructor.executeSql(query,params);var instances=result.rows._array.map(function(row){var instance=new constructor(row);return _this2.cleanObject(instance);});var _loop=function*_loop(relationName){var relation=_this2[relationName];if(typeof relation==='function'){yield Promise.all(instances.map(function(instance){return __awaiter(_this2,void 0,void 0,function*(){try{instance[relationName]=yield instance[relationName]();}catch(error){instance[relationName]=null;}});}));}};for(var relationName of this.clauses.withRelations){yield*_loop(relationName);}this.cleanObject(this);return instances;});}},{key:"first",value:function first(){return __awaiter(this,void 0,void 0,function*(){this.limit(1);var results=yield this.get();return results[0]||null;});}},{key:"update",value:function update(attributes){return __awaiter(this,void 0,void 0,function*(){Object.assign(this,attributes);return yield this.save();});}},{key:"cleanObject",value:function cleanObject(object){var constructor=this.constructor;for(var key in object){if(Object.prototype.hasOwnProperty.call(object,key)){var castType=constructor.casts[key];if(castType){object[key]=constructor.castAttribute(castType,object[key]);}}}delete object.clauses;return object;}},{key:"hasOne",value:function hasOne(relatedModel,foreignKey){var localKey=arguments.length>2&&arguments[2]!==undefined?arguments[2]:'id';return __awaiter(this,void 0,void 0,function*(){return yield relatedModel.where(foreignKey,'=',this[localKey]).first();});}},{key:"hasMany",value:function hasMany(relatedModel,foreignKey){var localKey=arguments.length>2&&arguments[2]!==undefined?arguments[2]:'id';return __awaiter(this,void 0,void 0,function*(){return yield relatedModel.where(foreignKey,'=',this[localKey]).get();});}},{key:"belongsTo",value:function belongsTo(relatedModel,foreignKey){var otherKey=arguments.length>2&&arguments[2]!==undefined?arguments[2]:'id';return __awaiter(this,void 0,void 0,function*(){return yield relatedModel.where(otherKey,'=',this[foreignKey]).first();});}},{key:"belongsToMany",value:function belongsToMany(relatedModel,joinTableName,foreignKey,otherKey){return __awaiter(this,void 0,void 0,function*(){var constructor=this.constructor;var relatedTableName=relatedModel.tableName;var currentTableName=constructor.tableName;if(!joinTableName){var _sort$join=[relatedTableName,currentTableName].sort().join('_');var _sort$join2=(0,_slicedToArray2.default)(_sort$join,1);joinTableName=_sort$join2[0];}if(!foreignKey){foreignKey=`${currentTableName.slice(0,-1)}Id`;}if(!otherKey){otherKey=`${relatedTableName.slice(0,-1)}Id`;}var instances=yield constructor.join('INNER',joinTableName,`${currentTableName}.id`,`${joinTableName}.${foreignKey}`).join('INNER',relatedTableName,`${joinTableName}.${otherKey}`,`${relatedTableName}.id`).where(`${currentTableName}.id`,'=',this.id).get();return instances;});}}],[{key:"get",value:function get(){return __awaiter(this,void 0,void 0,function*(){return yield new this().get();});}},{key:"table",value:function table(name){return new this().table(name);}},{key:"select",value:function select(){var fields=arguments.length>0&&arguments[0]!==undefined?arguments[0]:'*';return new this().select(fields);}},{key:"join",value:function join(type,table,firstKey,secondKey){return new this().join(type,table,firstKey,secondKey);}},{key:"where",value:function where(column,operatorOrValue,value){return new this().where(column,operatorOrValue,value);}},{key:"orderBy",value:function orderBy(column){var direction=arguments.length>1&&arguments[1]!==undefined?arguments[1]:'ASC';return new this().orderBy(column,direction);}},{key:"limit",value:function limit(number){return new this().limit(number);}},{key:"with",value:function _with(relation){var instance=new this().with(relation);return instance;}},{key:"find",value:function find(id){return __awaiter(this,void 0,void 0,function*(){return yield new this().where('id','=',id).first();});}},{key:"insert",value:function insert(data){return __awaiter(this,void 0,void 0,function*(){var _this3=this;var now=new Date().toISOString();var constructor=this;if(constructor.withTimestamps){data[constructor.createdAtColumn]=data[constructor.createdAtColumn]||now;data[constructor.updatedAtColumn]=data[constructor.updatedAtColumn]||now;}var fields=Object.keys(data);var placeholders=fields.map(function(){return'?';}).join(', ');var values=fields.map(function(field){return data[field];});var valuesForStorage=fields.map(function(field){return _this3.prepareAttributeForStorage(field,data[field]);});var sql=`INSERT INTO ${constructor.tableName} (${fields.join(', ')}) VALUES (${placeholders})`;return yield this.executeSql(sql,valuesForStorage);});}},{key:"seed",value:function seed(data){return __awaiter(this,void 0,void 0,function*(){var existingData=yield new this().first();if(!existingData){for(var item of data){yield this.insert(item);}}});}},{key:"executeSql",value:function executeSql(sql){var params=arguments.length>1&&arguments[1]!==undefined?arguments[1]:[];return __awaiter(this,void 0,void 0,function*(){var _this4=this;return yield new Promise(function(resolve,reject){_this4.db.transaction(function(tx){tx.executeSql(sql,params,function(_,result){resolve(result);},function(transaction,error){reject(error);});});});});}},{key:"castAttribute",value:function castAttribute(key,value){switch(key){case'number':return Number(value);case'boolean':return Boolean(value);case'string':return String(value);case'json':try{return JSON.parse(value);}catch(e){return value;}default:return value;}}},{key:"prepareAttributeForStorage",value:function prepareAttributeForStorage(key,value){var castType=this.casts[key];switch(castType){case'number':return isFinite(value)?Number(value):null;case'boolean':return value?1:0;case'string':return String(value);case'json':try{return JSON.stringify(value);}catch(e){return null;}default:return value;}}}]);return Model;}();exports.Model=Model;Model.db=SQLite.openDatabase('app.db');Model.tableName='';Model.casts={};Model.withTimestamps=true;Model.createdAtColumn='createdAt';Model.updatedAtColumn='updatedAt';